#!/bin/bash
set -x

go fmt
# cf. https://medium.com/@kelseyhightower/optimizing-docker-images-for-static-binaries-b5696e26eb07#.wmlq1nj3d
CGO_ENABLED=0 GOOS=linux go build -a -tags netgo -ldflags '-w' .

NAME="$(pwd | awk -F "/" '{print $NF}')" # Name of current subdirectory
docker-machine ssh manager docker service rm $NAME

echo "FROM scratch" > ./Dockerfile
echo "MAINTAINER Wouter Scherphof <wouter.scherphof@gmail.com>" >> ./Dockerfile
echo "ADD $NAME $NAME" >> ./Dockerfile
echo "EXPOSE 9090" >> ./Dockerfile
echo "ENTRYPOINT [\"/"$NAME"\"]" >> ./Dockerfile

if [ ! -f ./version ]; then
	echo "0" > ./version
fi
OLD_VERSION="$(cat ./version)"
NEW_VERSION="$(expr $OLD_VERSION + 1)"
echo "$NEW_VERSION" > ./version

for node in manager worker1 worker2 # Build image on each node. Alternatively, build locally once & push to a repository.
do
	docker-machine ssh $node docker rmi   -f wscherphof/$NAME:$OLD_VERSION
	docker-machine ssh $node docker build -t wscherphof/$NAME:$NEW_VERSION $PWD
done
docker-machine ssh manager docker service create --name $NAME --replicas 6 --network dbnet --publish 9090:9090 wscherphof/$NAME:$NEW_VERSION
rm ./$NAME ./Dockerfile
sleep 5

docker-machine ssh manager -fNL 9090:localhost:9090
open http://localhost:9090
