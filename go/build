#!/bin/bash

usage ()
{
	echo
	echo "Usage: $(basename $0) [OPTIONS] SOURCEDIR IMAGE [SWARM]"
	echo
	echo "Formats & compile go sources, and build a Docker image"
	echo
	echo "SOURCEDIR  directory containing the sources to compile"
	echo "IMAGE      repo/name:tag identifying the image"
	echo "SWARM      swarm on which nodes to build the image (instead of building locally, then pushing to reporitory)"
	echo
	echo "Options:"
	echo "  -p port ...  ports for the image to EXPOSE"
	echo "  -a file ...  files to ADD to the image's / folder (path relative to SOURCEDIR)"
	echo "  -A treeish   git branch/tag of the complete SOURCEDIR to ADD to the image's / folder"
	echo
}

while getopts "p:a:A:h" opt; do
    case $opt in
        p  ) PORTS+=("$OPTARG");;
        a  ) ADDS+=("$OPTARG");;
        A  ) TREEISH="$OPTARG";;
        h  ) usage; exit;;
        \? ) echo "Unknown option: -$OPTARG" >&2; exit 1;;
        :  ) echo "Missing option argument for -$OPTARG" >&2; exit 1;;
        *  ) echo "Unimplemented option: -$OPTARG" >&2; exit 1;;
    esac
done
shift $((OPTIND -1))

continue ()
{
	if [ "$?" != "0" ]; then
		exit $?
	fi
}

pushd "$1" 1>/dev/null
continue

echo "* formatting source code..."
go fmt
continue

echo "* compiling..."
# cf. https://medium.com/@kelseyhightower/optimizing-docker-images-for-static-binaries-b5696e26eb07#.wmlq1nj3d
CGO_ENABLED=0 GOOS=linux go build -a -tags netgo -ldflags '-w' .
continue

BINARY="$(pwd | awk -F "/" '{print $NF}')" # go build names the binary after the source's subdirectory

echo "FROM scratch" > ./Dockerfile
echo "ADD ${BINARY} /" >> ./Dockerfile
echo "EXPOSE ${PORTS[@]}" >> ./Dockerfile
echo "ENTRYPOINT [\"/${BINARY}\"]" >> ./Dockerfile

if [ "${TREEISH}" ]; then
	echo "ADD archive.tar.gz /" >> ./Dockerfile
	git archive --format tar.gz -o archive.tar.gz ${TREEISH} .
fi

TAG="$2"
ENV="$3"
if [ "${ENV}" ]; then
	# Build on all nodes, skipping the push to the repository.
	# Dirty, but quick.
	for add in "${ADDS[@]}"; do
		echo "ADD \"$(basename ${add})\"" \"/\" >> ./Dockerfile
	done
	for type in worker manager
	do
		for (( i=1; ; i++ ))
		do
			node="${ENV}-${type}-${i}"
			docker-machine status $node &>/dev/null
			if [ "$?" = "0" ]; then
				echo "* building image on $node..."
				dir="$(docker-machine ssh $node pwd)"
				if [ "${TREEISH}" ]; then
					docker-machine scp ./archive.tar.gz ${node}:${dir}
				fi
				docker-machine scp ./${BINARY} ${node}:${dir}
				docker-machine scp ./Dockerfile ${node}:${dir}
				for add in "${ADDS[@]}"; do
					docker-machine scp "${add}" ${node}:${dir}
				done
				docker-machine ssh $node sudo docker build -t ${TAG} .
			else
				break
			fi
		done
	done
else
	# Build locally and use the repository for shipping the image to the nodes.
	# Pretty, but slow.
	for add in "${ADDS[@]}"; do
		echo "ADD \"${add}\" \"/\"" >> ./Dockerfile
	done
	echo "* building image..."
	docker build -t ${TAG} .
	echo "* pushing image..."
	docker push ${TAG}
fi
rm ./${BINARY} ./Dockerfile ./archive.tar.gz

popd 1>/dev/null
