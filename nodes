#!/bin/bash

ENV="$1"
if [ ! "$ENV" ]; then
	echo "Usage:"
	echo "  nodes env [-do digitalocean-access-token] [type; manager or worker]"
	echo "  nodes env rm"
	echo "e.g. nodes dev"
	echo "  creates dev-manager-1, dev-worker-1, and dev-worker-2 on virtualbox"
	echo "e.g. nodes dev worker"
	echo "  creates an extra worker node"
	echo "e.g. nodes dev rm"
	echo "  removes all dev nodes"
	exit 1
fi

remove ()
{
	read -p "Type Y to remove ALL ${ENV} nodes... " answer
	if [ "$answer" != "Y" ]; then
		exit
	fi
	for type in worker manager
	do
		for (( i=1; ; i++ ))
		do
			docker-machine status ${ENV}-${type}-${i} &>/dev/null
			if [ "$?" = "0" ]; then
				docker-machine rm -f ${ENV}-${type}-${i}
			else
				break
			fi
		done
	done
}

if [ "$2" = "rm" ]; then
	remove
	exit
elif [ "$2" = "-do" ]; then
	DO="$3"
	TYPE="$4"
	DRIVER="digitalocean --digitalocean-access-token $DO --digitalocean-image ubuntu-16-04-x64"
else
	TYPE="$2"
	DRIVER="virtualbox --virtualbox-memory 1024 --virtualbox-cpu-count 2 --virtualbox-disk-size 10000"
fi

create ()
{
	type="$1"
	number="$2"
	node="${ENV}-${type}-${number}"
	docker-machine create --driver $DRIVER $node
	if [ "$?" != "0" ]; then
		echo "* $node create failed"
		return 1
	fi
	MANAGER_IP="$(docker-machine ip ${ENV}-manager-1)"
	if [ "$type" = "manager" ]; then
		if [ "$number" = "1" ]; then
			docker-machine ssh ${ENV}-manager-1 docker swarm init --advertise-addr $MANAGER_IP
		else	
			TOKEN="$(docker-machine ssh ${ENV}-manager-1 docker swarm join-token --quiet manager)"
			docker-machine ssh ${ENV}-manager-$number docker swarm join --token $TOKEN $MANAGER_IP:2377
		fi
	else
		TOKEN="$(docker-machine ssh ${ENV}-manager-1 docker swarm join-token --quiet worker)"
		docker-machine ssh ${ENV}-worker-$number docker swarm join --token $TOKEN $MANAGER_IP:2377
	fi
	if [ "$DO" ]; then
		docker-machine ssh $node ufw default deny incoming
		docker-machine ssh $node ufw default allow outgoing
		docker-machine ssh $node ufw allow ssh
		docker-machine ssh $node ufw allow http
		docker-machine ssh $node ufw allow https
		docker-machine ssh $node ufw allow 2376 # docker api
		docker-machine ssh $node ufw allow 2377 # docker swarm mode
		docker-machine ssh $node ufw allow 7946 # docker overlay
		docker-machine ssh $node ufw allow 4789 # ??
		docker-machine ssh $node ufw --force enable
	fi
	docker-machine restart $node
	if [ "$?" != "0" ]; then
		echo "* $node restart failed"
		return 1
	else
		echo "* $node ready"
	fi
}

if [ "$TYPE" ]; then
	for (( i=1; ; i++ ))
	do
		docker-machine status ${ENV}-${TYPE}-${i} &>/dev/null
		if [ "$?" != "0" ]; then
			NUMBER="$i"
			break
		fi
	done
	create $TYPE $NUMBER
else
	remove
	create manager 1
	create worker 1 &
	create worker 2
fi
