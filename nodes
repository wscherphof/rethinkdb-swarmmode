#!/bin/bash

usage ()
{
	echo "Usage:"
	echo "  nodes env [-d driver] [type; manager or worker]"
	echo "  nodes env stop"
	echo "  nodes env start"
	echo "  nodes env rm"
	echo "e.g. nodes dev"
	echo "  creates dev-manager-1, dev-worker-1, and dev-worker-2 on virtualbox"
	echo "e.g. nodes dev worker"
	echo "  creates an extra worker (dev-worker-3) on virtualbox"
	echo "e.g. nodes tst -d digitalocean"
	echo "  creates tst-manager-1, tst-worker-1, and tst-worker-2 on digitalocean"
	echo "  use environment values to specify mandatory and optional settings"
	echo "e.g. nodes tst -d google worker"
	echo "  creates an extra worker (tst-worker-3) on google compute engine"
	echo "  use environment values to specify mandatory and optional settings"
	echo "e.g. nodes dev stop"
	echo "  stops all dev nodes"
	echo "e.g. nodes dev start"
	echo "  starts all dev nodes"
	echo "e.g. nodes dev rm"
	echo "  removes all dev nodes"
	exit 1
}

if [ "$1" = "" -o "$1" = "help" -o "$1" = "-h" -o "$1" = "--help" ]; then
	usage
else
	ENV="$1"
fi

loop ()
{
	command="$1"
	for type in worker manager
	do
		for (( i=1; ; i++ ))
		do
			docker-machine status ${ENV}-${type}-${i} &>/dev/null
			if [ "$?" = "0" ]; then
				docker-machine $command ${ENV}-${type}-${i}
			else
				break
			fi
		done
	done
}

remove ()
{
	read -p "Type Y to remove ALL ${ENV} nodes... " answer
	if [ "$answer" != "Y" ]; then
		return
	fi
	loop "rm -f"
}

if [ "$2" = "stop" ]; then
	loop "stop"
	exit 0
elif [ "$2" = "start" ]; then
	loop "start"
	exit 0
elif [ "$2" = "rm" ]; then
	remove
	exit 0
elif [ "$2" = "-d" -o "$2" = "--driver" ]; then
	DRIVER="$3"
	TYPE="$4"
	FIREWALL="y"
elif [ "$2" = "" -o "$2" = "manager" -o "$2" = "worker" ]; then
	TYPE="$2"
	DRIVER="virtualbox"
else
	usage
fi

create ()
{
	type="$1"
	number="$2"
	node="${ENV}-${type}-${number}"
	docker-machine create --driver $DRIVER $node
	if [ "$?" != "0" ]; then
		echo "* $node create failed"
		return 1
	fi
	MANAGER_IP="$(docker-machine ip ${ENV}-manager-1)"
	if [ "$type" = "manager" ]; then
		if [ "$number" = "1" ]; then
			docker-machine ssh ${ENV}-manager-1 sudo docker swarm init --advertise-addr $MANAGER_IP
		else	
			TOKEN="$(docker-machine ssh ${ENV}-manager-1 sudo docker swarm join-token --quiet manager)"
			docker-machine ssh ${ENV}-manager-$number sudo docker swarm join --token $TOKEN $MANAGER_IP:2377
		fi
	else
		TOKEN="$(docker-machine ssh ${ENV}-manager-1 sudo docker swarm join-token --quiet worker)"
		docker-machine ssh ${ENV}-worker-$number sudo docker swarm join --token $TOKEN $MANAGER_IP:2377
	fi
	if [ "$FIREWALL" ]; then
		dir="$(docker-machine ssh $node pwd)"
		docker-machine scp ./firewall ${node}:${dir}
		docker-machine ssh $node . ${dir}/firewall
	fi
	docker-machine restart $node
	if [ "$?" != "0" ]; then
		echo "* $node restart failed"
		return 1
	else
		echo "* $node ready"
	fi
}

cat > ./firewall << EOF
	sudo ufw default deny incoming
	sudo ufw default allow outgoing
	sudo ufw allow ssh/tcp
	sudo ufw allow http/tcp
	sudo ufw allow https/tcp
	sudo ufw allow 2376/tcp # docker api
	sudo ufw allow 2377/tcp # docker swarm mode
	sudo ufw allow 7946     # docker overlay network
	sudo ufw allow 4789/udp # vxlan
	sudo ufw --force enable
EOF

if [ "$TYPE" ]; then
	for (( i=1; ; i++ ))
	do
		docker-machine status ${ENV}-${TYPE}-${i} &>/dev/null
		if [ "$?" != "0" ]; then
			NUMBER="$i"
			break
		fi
	done
	create $TYPE $NUMBER
else
	remove
	create manager 1
	create worker 1 &
	create worker 2
fi

rm ./firewall
